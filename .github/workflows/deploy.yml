name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ inputs.version }}
    
    - name: Validate version tag
      run: |
        if ! git rev-parse ${{ inputs.version }} >/dev/null 2>&1; then
          echo "Error: Version tag ${{ inputs.version }} does not exist"
          exit 1
        fi
    
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
    
    - name: Deploy to server
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Deploying Impetus LLM Server ${{ inputs.version }} to ${{ inputs.environment }}..."
        
        # Variables
        DEPLOY_PATH="${DEPLOY_PATH}"
        VERSION="${{ inputs.version }}"
        BACKUP_DIR="${DEPLOY_PATH}/backups/$(date +%Y%m%d_%H%M%S)"
        
        # Create backup
        echo "Creating backup..."
        mkdir -p "$BACKUP_DIR"
        if [ -d "${DEPLOY_PATH}/current" ]; then
          cp -r "${DEPLOY_PATH}/current" "$BACKUP_DIR/"
        fi
        
        # Clone or update repository
        echo "Updating code..."
        cd "$DEPLOY_PATH"
        if [ ! -d "repo" ]; then
          git clone https://github.com/GerdsenAI/Impetus-LLM-Server.git repo
        fi
        
        cd repo
        git fetch --all --tags
        git checkout "$VERSION"
        git pull origin "$VERSION"
        
        # Create new release directory
        RELEASE_DIR="${DEPLOY_PATH}/releases/${VERSION}"
        mkdir -p "$RELEASE_DIR"
        cp -r . "$RELEASE_DIR/"
        
        # Install/update dependencies
        echo "Installing dependencies..."
        cd "$RELEASE_DIR/gerdsen_ai_server"
        
        # Create virtual environment if it doesn't exist
        if [ ! -d "venv" ]; then
          python3 -m venv venv
        fi
        
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements_production.txt
        
        # Build frontend
        echo "Building frontend..."
        cd "$RELEASE_DIR/impetus-dashboard"
        pnpm install --frozen-lockfile
        pnpm build
        
        # Run database migrations (if any)
        # echo "Running migrations..."
        # cd "$RELEASE_DIR/gerdsen_ai_server"
        # python src/manage.py migrate
        
        # Update symlink
        echo "Updating symlink..."
        cd "$DEPLOY_PATH"
        rm -f current
        ln -s "releases/${VERSION}" current
        
        # Restart service
        echo "Restarting service..."
        sudo systemctl restart impetus
        
        # Health check
        echo "Running health check..."
        sleep 5
        if curl -f http://localhost:8080/api/health/status; then
          echo "Deployment successful!"
        else
          echo "Health check failed! Rolling back..."
          rm -f current
          if [ -d "$BACKUP_DIR/current" ]; then
            ln -s "$BACKUP_DIR/current" current
          fi
          sudo systemctl restart impetus
          exit 1
        fi
        
        # Clean up old releases (keep last 5)
        echo "Cleaning up old releases..."
        cd "${DEPLOY_PATH}/releases"
        ls -t | tail -n +6 | xargs -r rm -rf
        
        echo "Deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script
        scp deploy.sh ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/
        ssh ${DEPLOY_USER}@${DEPLOY_HOST} "bash /tmp/deploy.sh && rm /tmp/deploy.sh"
    
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Deployment to ${{ inputs.environment }} ${{ job.status }}
          Version: ${{ inputs.version }}
          Actor: ${{ github.actor }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Create deployment record
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: '${{ inputs.version }}',
            environment: '${{ inputs.environment }}',
            description: 'Deployed via GitHub Actions',
            auto_merge: false,
            required_contexts: []
          });