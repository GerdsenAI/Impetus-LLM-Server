name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - premium-llm-server
      - develop

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Label PR based on changes
  label-pr:
    name: Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/labeler@v4
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        configuration-path: .github/labeler.yml

  # Check PR title follows conventional commits
  check-pr-title:
    name: Check PR Title
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        validateSingleCommit: false

  # Python checks
  python-checks:
    name: Python Checks
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        cd gerdsen_ai_server
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov ruff mypy black isort
    
    - name: Check code formatting with black
      run: |
        cd gerdsen_ai_server
        black --check src/ tests/
      continue-on-error: true
    
    - name: Check import sorting with isort
      run: |
        cd gerdsen_ai_server
        isort --check-only src/ tests/
      continue-on-error: true
    
    - name: Run linting with ruff
      run: |
        cd gerdsen_ai_server
        ruff check src/ tests/ --output-format=github
    
    - name: Run type checking with mypy
      run: |
        cd gerdsen_ai_server
        mypy src/ --ignore-missing-imports --no-error-summary
      continue-on-error: true
    
    - name: Run tests with coverage
      run: |
        cd gerdsen_ai_server
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term --cov-report=html
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./gerdsen_ai_server/coverage.xml
        flags: backend
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: python-coverage-report
        path: gerdsen_ai_server/htmlcov/
    
    - name: Comment coverage on PR
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 60

  # Frontend checks
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8
    
    - name: Cache pnpm dependencies
      uses: actions/cache@v4
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
    
    - name: Install dependencies
      run: |
        cd impetus-dashboard
        pnpm install
    
    - name: Run ESLint
      run: |
        cd impetus-dashboard
        pnpm lint
    
    - name: Run TypeScript checks
      run: |
        cd impetus-dashboard
        pnpm tsc --noEmit
    
    - name: Build frontend
      run: |
        cd impetus-dashboard
        pnpm build
    
    - name: Check bundle size
      run: |
        cd impetus-dashboard
        # Report bundle size
        echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        find dist -name "*.js" -o -name "*.css" | while read file; do
          size=$(ls -lh "$file" | awk '{print $5}')
          echo "| ${file#dist/} | $size |" >> $GITHUB_STEP_SUMMARY
        done

  # Security checks
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Check Python dependencies with pip-audit
      run: |
        pip install pip-audit
        cd gerdsen_ai_server
        pip-audit -r requirements.txt -r requirements_production.txt --desc
      continue-on-error: true
    
    - name: Check for secrets with gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Documentation checks
  docs-checks:
    name: Documentation Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check markdown files
      uses: DavidAnson/markdownlint-cli2-action@v13
      with:
        globs: |
          **/*.md
          !**/node_modules/**
          !**/.venv/**
      continue-on-error: true
    
    - name: Check for broken links
      uses: lycheeverse/lychee-action@v1
      with:
        args: --verbose --no-progress './**/*.md' './**/*.html'
        fail: false

  # Test macOS app build
  test-macos-build:
    name: Test macOS App Build
    runs-on: macos-latest
    if: |
      contains(github.event.pull_request.labels.*.name, 'build') ||
      contains(github.event.pull_request.labels.*.name, 'installer') ||
      contains(github.event.pull_request.files.*.filename, 'installers/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Test standalone app build
      run: |
        cd installers
        # Run in test mode (if we add a --test flag)
        chmod +x macos_standalone_app.sh
        # For now, just check syntax
        bash -n macos_standalone_app.sh
    
    - name: Check installer scripts
      run: |
        cd installers
        # Check all shell scripts for syntax errors
        for script in *.sh; do
          echo "Checking $script..."
          bash -n "$script"
        done

  # Summary comment
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [python-checks, frontend-checks, security-checks, docs-checks]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
    - name: Comment PR summary
      uses: actions/github-script@v7
      with:
        script: |
          const checks = {
            'Python Checks': '${{ needs.python-checks.result }}',
            'Frontend Checks': '${{ needs.frontend-checks.result }}',
            'Security Checks': '${{ needs.security-checks.result }}',
            'Documentation': '${{ needs.docs-checks.result }}'
          };
          
          let allPassed = true;
          let summary = '## ðŸ“‹ PR Check Summary\n\n';
          
          for (const [check, result] of Object.entries(checks)) {
            const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
            summary += `${emoji} **${check}**: ${result}\n`;
            if (result !== 'success') allPassed = false;
          }
          
          summary += '\n';
          
          if (allPassed) {
            summary += '### ðŸŽ‰ All checks passed!\n\n';
            summary += 'This PR is ready for review.\n';
          } else {
            summary += '### âš ï¸ Some checks need attention\n\n';
            summary += 'Please review the failed checks above.\n';
          }
          
          summary += '\n---\n';
          summary += `ðŸ¤– *Generated by [Impetus CI/CD](${context.payload.pull_request.html_url}/checks)*`;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('PR Check Summary')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }