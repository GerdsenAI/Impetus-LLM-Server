name: Build macOS App

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: false
        type: string
        default: '1.0.0'
      upload_artifacts:
        description: 'Whether to upload artifacts'
        required: false
        type: boolean
        default: true
    outputs:
      dmg_name:
        description: 'Name of the DMG file'
        value: ${{ jobs.build.outputs.dmg_name }}
      dmg_size:
        description: 'Size of the DMG file'
        value: ${{ jobs.build.outputs.dmg_size }}
      sha256:
        description: 'SHA256 checksum of the DMG'
        value: ${{ jobs.build.outputs.sha256 }}

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  build:
    name: Build Standalone App
    runs-on: macos-latest
    outputs:
      dmg_name: ${{ steps.build-info.outputs.dmg_name }}
      dmg_size: ${{ steps.build-info.outputs.dmg_size }}
      sha256: ${{ steps.build-info.outputs.sha256 }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up build environment
      run: |
        echo "Setting up build environment..."
        echo "Build version: ${{ inputs.version }}"
        
        # Install required tools
        brew install create-dmg || true
        
        # Set up Python
        echo "Python version: $(python3 --version)"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('gerdsen_ai_server/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8
        run_install: false
    
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: Update version number
      run: |
        VERSION="${{ inputs.version }}"
        echo "Updating version to $VERSION"
        
        # Update version in setup.py
        sed -i '' "s/version=\"[0-9.]*\"/version=\"$VERSION\"/" setup.py
        
        # Update version in package.json
        cd impetus-dashboard
        npm version $VERSION --no-git-tag-version
        cd ..
        
        # Update version in installer script
        sed -i '' "s/PRODUCT_VERSION=\"[0-9.]*\"/PRODUCT_VERSION=\"$VERSION\"/" installers/macos_standalone_app.sh
    
    - name: Install Python dependencies
      run: |
        cd gerdsen_ai_server
        python -m pip install --upgrade pip wheel
        pip install -r requirements.txt
        pip install -r requirements_production.txt
        cd ..
    
    - name: Build frontend
      run: |
        cd impetus-dashboard
        pnpm install
        pnpm build
        
        # Check if build was successful
        if [ ! -d "dist" ]; then
          echo "Frontend build failed - dist directory not found"
          exit 1
        fi
        
        echo "Frontend build successful"
        ls -la dist/
        cd ..
    
    - name: Pre-build verification
      run: |
        echo "Verifying build prerequisites..."
        
        # Check Python
        python3 --version
        
        # Check required files
        for file in "gerdsen_ai_server/src/main.py" "impetus-dashboard/dist/index.html" "installers/macos_standalone_app.sh"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file not found"
            exit 1
          fi
        done
        
        echo "All prerequisites verified"
    
    - name: Build standalone macOS app
      id: build-app
      run: |
        cd installers
        
        # Make script executable
        chmod +x macos_standalone_app.sh
        
        # Run the build
        echo "Starting build process..."
        ./macos_standalone_app.sh
        
        # Verify build output
        if [ ! -d "build_standalone/Impetus.app" ]; then
          echo "Error: App bundle not created"
          exit 1
        fi
        
        # Find the DMG file
        DMG_FILE=$(ls *.dmg 2>/dev/null | head -1)
        if [ -z "$DMG_FILE" ]; then
          echo "Error: DMG file not created"
          exit 1
        fi
        
        echo "Build successful: $DMG_FILE"
        echo "dmg_file=$DMG_FILE" >> $GITHUB_OUTPUT
    
    - name: Create checksums and gather info
      id: build-info
      run: |
        cd installers
        DMG_FILE="${{ steps.build-app.outputs.dmg_file }}"
        
        # Create checksums
        shasum -a 256 "$DMG_FILE" > "$DMG_FILE.sha256"
        SHA256=$(cat "$DMG_FILE.sha256" | awk '{print $1}')
        
        # Get file size
        DMG_SIZE=$(ls -lh "$DMG_FILE" | awk '{print $5}')
        
        # Output information
        echo "dmg_name=$DMG_FILE" >> $GITHUB_OUTPUT
        echo "dmg_size=$DMG_SIZE" >> $GITHUB_OUTPUT
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        
        # Create build info file
        cat > build-info.json << EOF
        {
          "version": "${{ inputs.version }}",
          "dmg_name": "$DMG_FILE",
          "dmg_size": "$DMG_SIZE",
          "sha256": "$SHA256",
          "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "build_number": "${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}"
        }
        EOF
        
        echo "Build info:"
        cat build-info.json
    
    - name: Test app bundle
      run: |
        cd installers/build_standalone
        
        # Basic verification
        echo "Verifying app bundle structure..."
        
        # Check Info.plist
        if [ ! -f "Impetus.app/Contents/Info.plist" ]; then
          echo "Error: Info.plist not found"
          exit 1
        fi
        
        # Check executable
        if [ ! -f "Impetus.app/Contents/MacOS/Impetus" ]; then
          echo "Error: Main executable not found"
          exit 1
        fi
        
        # Check Python runtime
        if [ ! -d "Impetus.app/Contents/Resources/python" ]; then
          echo "Error: Python runtime not bundled"
          exit 1
        fi
        
        # Check permissions
        if [ ! -x "Impetus.app/Contents/MacOS/Impetus" ]; then
          echo "Error: Main executable not executable"
          exit 1
        fi
        
        echo "App bundle verification passed"
    
    - name: Upload DMG artifact
      if: inputs.upload_artifacts
      uses: actions/upload-artifact@v4
      with:
        name: impetus-macos-dmg
        path: |
          installers/*.dmg
          installers/*.dmg.sha256
          installers/build-info.json
        retention-days: 7
    
    - name: Upload app bundle for testing
      if: inputs.upload_artifacts
      uses: actions/upload-artifact@v4
      with:
        name: impetus-macos-app
        path: installers/build_standalone/Impetus.app
        retention-days: 1
    
    - name: Generate build report
      run: |
        cd installers
        
        cat > build-report.md << EOF
        # Build Report
        
        ## Build Information
        - **Version**: ${{ inputs.version }}
        - **DMG File**: ${{ steps.build-info.outputs.dmg_name }}
        - **Size**: ${{ steps.build-info.outputs.dmg_size }}
        - **SHA256**: \`${{ steps.build-info.outputs.sha256 }}\`
        - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Build Number**: ${{ github.run_number }}
        
        ## Contents
        - Standalone macOS application
        - Embedded Python ${{ env.PYTHON_VERSION }} runtime
        - All dependencies pre-installed
        - React dashboard (pre-built)
        
        ## Requirements
        - macOS 13.0 or later
        - Apple Silicon (M1/M2/M3/M4)
        - No additional dependencies required
        
        ## Installation
        1. Download the DMG file
        2. Open the DMG
        3. Drag Impetus to Applications
        4. Double-click to run
        EOF
        
        echo "Build report generated"